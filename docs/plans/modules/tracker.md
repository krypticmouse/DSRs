# Implementation Tracker

> Historical note: entries in this file are an execution log. Older entries may reference removed APIs and are kept as archival context.

## Current State
- **Slice**: 6 (V6 dynamic graph + post-stage hardening)
- **Phase**: Post-Implementation Cleanup (shape/breadboard hardening in progress)
- **Primary kickoff doc**: `docs/plans/modules/phase_4_5_cleanup_kickoff.md`
- **Current deferred-ledger source**: `docs/plans/modules/slices_closure_audit.md`
- **Roadmap**: Stage 1 cleanup (legacy kill pass + typed metric optimizer path) → Stage 2 runtime/docs hardening (shape/breadboard) → remaining post-cleanup debt
- **Roadmap rationale**: Slices 1-6 are implemented; active work is convergence cleanup and API/docs/test hardening.

## Active Subagents
| ID | Purpose | Slice | Phase | Status | Notes |
|----|---------|-------|-------|--------|-------|

## Completed Subagents
| ID | Purpose | Slice | Phase | Outcome |
|----|---------|-------|-------|---------|
| `019c41ac-7619-7013-9147-858cc5d57ebe` | Research brief for V1 typed call | 1 | Research | Completed; confirmed V1 chokepoints are `Signature`/adapter/predictor return surfaces and identified flat-`FieldSpec` gaps vs target `SignatureSchema` path model |
| `019c41bd-b436-72e3-a9f6-7be83ad9aafc` | Research brief for Slice 1 (V1 typed call) | 1 | Research | Completed; produced `slice_1_research.md` with code-level inventory and migration path; reviewed and amended for strict Slice 1 scope |
| `019c41c1-87a7-7eb0-8959-4316b2a12033` | Stupidly implementable plan for Slice 1 (V1 typed call) | 1 | Plan | Completed; generated `slice_1.md` draft with file-level steps, but initial review flagged divergence from S1/S6 full-replacement decisions |
| `019c41c5-0229-73f3-9874-4d88971cfc65` | Plan refinery against ground truth for Slice 1 | 1 | Plan Refinery | Completed; produced `slice_1_refinery.md`, corrected plan fidelity issues, and surfaced arbitration points that were resolved in `slice_1.md` |
| `019c41ca-9537-7e01-9ab4-d560308f1cd3` | Implement Slice 1 plan in code/tests | 1 | Implement | Partial; edited core/macro/adapter/predict surfaces but left compile break (`core/module.rs` delimiter), incomplete test migration, and unexpected out-of-scope edits in optimizer files (`optimizer/gepa.rs`, `optimizer/mipro.rs`) |
| `manual` | Implement Slice 1 completion pass | 1 | Implement | Completed; fixed compile break, finalized `CallOutcome`/schema test migration, added `test_signature_schema.rs` + `test_call_outcome.rs` + `test_chat_adapter_schema.rs`, and updated typed integration tests to `Predict::call(...).await.into_result()` |
| `019c41e1-6eb1-76e2-9402-aee1bdb2f20e` | Adversarial review against ground truth | 1 | Adversarial Review | Completed; reported one high finding (`MetaSignature` flatten marker mismatch); finding accepted and fixed by switching legacy field keys to `lm_name` and broadening header parser regex |
| `019c41e9-c4a2-7c93-9e85-b76d8e8e5bae` | Research brief for Slice 2 (V2 augmentation + CoT) | 2 | Research | Completed; produced `slice_2_research.md` and amended gap analysis to reflect current Slice 1 state (typed path already `FieldPath`-based; residual split helpers and augmentation/CoT gaps remain) |
| `019c41ed-b602-7530-9c6c-80ba69ba9c24` | Stupidly implementable plan for Slice 2 (V2 augmentation + CoT) | 2 | Plan | Failed/no output; subagent returned no completion and did not create `slice_2.md` |
| `019c43b1-97e4-7391-b609-750ee9d2e188` | Replacement planning brief for Slice 2 (V2 augmentation + CoT) | 2 | Plan | Completed; generated `slice_2.md`, but initial review found spec fidelity issues requiring refinery (incorrect `Augmented` trait modeling, over-strong `DerefMut` requirement, and non-canonical CoT constructor shape) |
| `019c43b4-cc15-7141-8644-166205cf4a26` | Plan refinery against ground truth for Slice 2 | 2 | Plan Refinery | Completed; produced `slice_2_refinery.md`, updated `slice_2.md`, and surfaced one arbitration item now resolved (`ChainOfThoughtBuilder` delegates full `PredictBuilder` DSL; wrappers remain `Deref`-only) |
| `019c43be-fa6e-7080-97d8-08ceaab8c4db` | Implement Slice 2 plan in code/tests | 2 | Implement | Partial; macro conflicts required manual completion and additional adapter/schema adjustments to align flattened augmentation fields |
| `019c43e9-045c-7693-bc73-2e13531c3b28` | Adversarial review against ground truth | 2 | Adversarial Review | Completed; produced `slice_2_review.md` with three findings (missing Facet on `ChainOfThought`, untyped `Module::forward` mismatch against design example, and empty legacy `parameters()` visibility) |
| `019c4412-6e17-7fb2-8abf-321f4e4d415e` | Apply agreed Slice 2 arbitration fix (legacy optimizer visibility) | 2 | Arbitrate | Completed; updated `ChainOfThought::parameters()` to expose `predictor` and added regression test `chain_of_thought_parameters_expose_predictor_for_legacy_optimizers` |
| `019c4415-5851-70e3-8e74-bc49d59c9f86` | Research brief for Slice 3 (module authoring) | 3 | Research | Failed; no output | Subagent rejected by prompt-policy guard before execution; replacing with narrower prompt |
| `019c4415-ba6f-7b91-a931-e09e979b47b7` | Research brief for Slice 3 (module authoring) | 3 | Research | Completed; produced `slice_3_research.md` covering V3/F4/F12 requirements, current code references, and migration gaps | Reviewed and accepted with added caution on trait migration blast radius |
| `019c441e-01f4-75f1-9905-3da3bf970159` | Stupidly implementable plan for Slice 3 (module authoring) | 3 | Plan | Completed; produced `slice_3.md` with sequencing/tests for V3 migration | Initial review found directional correctness but concrete API/name mismatches requiring refinery correction |
| `019c441f-07b6-7d00-a7cd-7c47d3714b5b` | Plan refinery against ground truth for Slice 3 | 3 | Plan Refinery | Completed; produced `slice_3_refinery.md` and updated `slice_3.md` with coverage notes, including explicit test comprehensiveness check | No unresolved `NEEDS ARBITRATION` markers remained; final arbitration moved to direct code-grounded implementation due stale/non-existent API names still present in the plan text |
| `019c4439-b9ac-7721-885e-6147e96f8d40` | Adversarial review against ground truth for Slice 3 | 3 | Adversarial Review | Completed; produced `slice_3_review.md` with 2 high, 2 medium, 1 low finding | Findings reviewed during Arbitrate; no additional fix subagent required for this slice pass |
| `manual` | Closure audit and bookkeeping pass for slices 1–3 | 3 | Closure Audit | Completed; created `slices_1_3_closure_audit.md`, removed stale unresolved marker from `slice_2_refinery.md`, and mapped all non-implemented items to explicit follow-up phases | Closure audit introduces explicit post-commit phase `Closure Audit` for future slices as well |
| `019c4458-b5c5-7bd3-9c7e-82b427d6ca36` | Research brief for Slice 4 (ReAct + operational affordances) | 4 | Research | Completed; produced `slice_4_research.md` with V4 requirement inventory and repo-grounded gap analysis | Amended post-review to mark `U48` as `[MODIFY]` because current `forward_all` requires a fourth `display_progress` arg versus spec’s 3-arg ergonomic surface |
| `019c445d-861f-7d93-b2af-28bdcfb3e3da` | Stupidly implementable plan for Slice 4 (ReAct + operational affordances) | 4 | Plan | Failed/no output | Subagent prompt was blocked by policy guard before execution; replacing with narrower prompt |
| `019c4461-f155-7233-8244-25d9491d2957` | Replacement planning brief for Slice 4 (ReAct + operational affordances) | 4 | Plan | Completed; generated `slice_4.md` with implementation/test steps for U14/U48/U51 | Initial review accepted direction; flagged speculative details (`#[facet(skip)]` closure handling and ReAct tool-wrapper API shape) for plan refinery arbitration |
| `019c4467-1e16-7b82-a306-2989dd593944` | Plan refinery against ground truth for Slice 4 | 4 | Plan Refinery | Completed; produced `slice_4_refinery.md` and updated `slice_4.md` with spec/shape consistency checks | One ambiguity surfaced (`and_then` metadata semantics) and was resolved during arbitration in the approved plan |
| `019c4475-b295-75b0-8b03-ecfd11932e5f` | Adversarial review against ground truth for Slice 4 | 4 | Adversarial Review | Completed; produced `slice_4_review.md` with one high and one medium finding | High: ReAct missing `Facet` derivation/discoverability. Medium: ReAct loop prompt formatting bypasses adapter building blocks |
| `019c4478-d3ef-76b1-98e9-cbf5f4d127ec` | Apply agreed Slice 4 arbitrate fix (ReAct Facet discoverability) | 4 | Arbitrate | Completed; added `facet::Facet` derive on `ReAct` and skipped non-discoverable fields (`tools`, `max_steps`) while keeping predictor fields discoverable | Verified by `cargo check -p dspy-rs`, then re-ran targeted tests and Slice 4 smoke successfully |
| `manual` | ReAct DSPy parity pass (single call surface + trajectory smoke evidence) | 4 | Implement → Smoke Test | Completed; removed public `call_with_trajectory`, kept trajectory in normal `Predicted` metadata, upgraded deterministic test to multi-tool calculator loop, and replaced smoke with GPT-5.2 calculator trajectory proof | `cargo test -p dspy-rs --test test_module_forward_all --test test_module_ext --test test_react_builder` and `cargo run -p dspy-rs --example 93-smoke-slice4-react-operational` passed |
| `019c4536-e461-7792-ad3e-3c1115103a7a` | Research brief for Slice 5 (optimizer interface) | 5 | Research | Completed; created `slice_5_research.md` with V5 requirement inventory, existing optimizer/discovery surfaces, and [EXISTS]/[MODIFY]/[NEW] gaps for `DynPredictor` + walker migration |
| `019c453b-9133-7b23-bb4d-6cb001dea031` | Stupidly implementable plan for Slice 5 (optimizer interface) | 5 | Plan | Completed; created `slice_5.md` with concrete file-level steps for `DynPredictor`, Facet walker discovery, optimizer rewiring, and regression tests |
| `019c4542-56ae-73a2-bcf6-8078d6368393` | Plan refinery against ground truth for Slice 5 | 5 | Plan Refinery | Completed; created `slice_5_refinery.md`, updated `slice_5.md`, and surfaced C4 evaluator-surface arbitration for owner decision |
| `019c4564-8a9e-7e60-8c67-f45160adb26f` | Adversarial review against ground truth for Slice 5 | 5 | Adversarial Review | Completed; created `slice_5_review.md` with 6 findings (2 high, 2 medium, 2 low) and evidence paths |
| `019c456a-ec36-75e0-bc4e-f3028aca1001` | Arbitrate fixes for Slice 5 review findings | 5 | Arbitrate | Completed; fixed pointer/Box container erroring in walker and added V5 coverage for dump/load-state + deterministic multi-leaf discovery ordering |
| `019c4573-3f66-7e03-b1f8-b9dbb69e0738` | Research brief for Slice 6 (V6 dynamic graph) | 6 | Research | Completed; created `slice_6_research.md` with V6/F9/F10 requirements, existing inventory, and [EXISTS]/[MODIFY]/[NEW] gaps |
| `019c457a-a6d4-7892-8e0a-cc58d11f80a1` | Stupidly implementable plan for Slice 6 (V6 dynamic graph) | 6 | Plan | Failed/no output; subagent stalled without producing `slice_6.md` after repeated waits and interrupt request |
| `019c4582-c2dc-7f81-963c-2b2b2780005d` | Replacement stupidly implementable plan for Slice 6 (V6 dynamic graph) | 6 | Plan | Completed; produced `slice_6.md` with required sections, grounded signatures, and snapshot-then-fit-back contract from the resolved ambiguity (`from_module` immutable projection + `fit` mutable write-back) |
| `019c458b-e671-7b13-9b7b-d3921607a791` | Plan refinery against ground truth for Slice 6 | 6 | Plan Refinery | Completed; produced `slice_6_refinery.md` and updated `slice_6.md` with fidelity corrections (`StrategyError`, `format_output_baml`, `insert_between` coverage, execution-order note, `from_parts` visibility tightening) plus two arbitration markers |
| `019c45a4-fb62-7e62-8efa-b2d050d15e2c` | Adversarial review against ground truth for Slice 6 | 6 | Adversarial Review | Completed; produced `slice_6_review.md` with 6 findings (2 high, 3 medium, 1 low) used for Slice 6 arbitrate fixes |
| `019c469b-8f1c-7313-9aa8-2f32cabbae39` | Stage 1 adversarial audit #1 (legacy residue) | 6 | Post-Implementation Cleanup | Completed; no P0/P1 code findings, flagged README stale optimizer docs (P2) |
| `019c469b-8f42-74d1-b78b-811190ddfbf1` | Stage 1 adversarial audit #2 (typed API fidelity) | 6 | Post-Implementation Cleanup | Completed; flagged P1 doc/API mismatch (`README` + `gepa.mdx`) and confirmed runtime typed contract |
| `019c469b-8f67-72d2-a0e8-74f56b9f0435` | Stage 1 adversarial audit #3 (typed test matrix) | 6 | Post-Implementation Cleanup | Completed; flagged targeted typed-path coverage gaps (partial-feedback GEPA, input-key conversion guard, nested walker paths, metadata parity) |
| `019c46a5-b446-7c10-8291-ae7b41c09017` | Stage 1 adversarial re-audit A (docs/code consistency) | 6 | Post-Implementation Cleanup | Completed; no P0/P1 mismatches in tracker + closure + breadboard against current code |
| `019c46a5-b46a-77a0-b29e-8a5c6e2e0965` | Stage 1 adversarial re-audit B (typed contract fidelity) | 6 | Post-Implementation Cleanup | Completed; contract validated; re-confirmed README + GEPA user-doc API drift as P1 docs-only debt |
| `019c46a5-b490-7780-b7ee-88624e8ffee7` | Stage 1 adversarial re-audit C (typed coverage matrix) | 6 | Post-Implementation Cleanup | Completed; confirmed prior gaps mostly closed; flagged remaining optimizer parity gap (invalid input_keys guard missing for GEPA/MIPRO at audit start) |

## Decisions & Architectural Notes
<!-- Log every non-obvious decision, especially cross-slice implications -->
- **Stage 2 shape/breadboard hardening (2026-02-10):** Removed global graph-edge annotation registration from active runtime surface in favor of explicit per-call annotations (`from_module_with_annotations`), kept `from_module` canonical, and expanded regression coverage around projection/fit invariants.
- **Stage 1 adversarial re-audit (2026-02-10):** Re-ran 3 independent explorer audits after restoring planner/spec detail updates (`tracker`, `slices_closure_audit`, `breadboard`); no new code-level P0/P1 findings.
- **Stage 1 typed coverage hardening (2026-02-10):** Closed remaining optimizer input-key guard gap by adding invalid `input_keys` failure-path tests for both MIPRO and GEPA (`test_optimizer_typed_metric.rs`, `test_gepa_typed_metric_feedback.rs`) in addition to existing COPRO coverage.
- **Stage 1 docs-risk note (2026-02-10):** Adversarial audits continue to flag user-facing API drift in `README.md` and `docs/docs/optimizers/gepa.mdx` (legacy evaluator/compile snippets); retained as explicit docs-only debt pending owner-approved wording pass.
- **Stage 1 cleanup execution (2026-02-10):** Implemented one-shot removal of legacy optimizer/signature surfaces and migrated optimizer/evaluator APIs to typed metric path (`Optimizer::compile(&mut module, trainset, metric)`, `TypedMetric`, GEPA feedback-gated `compile`).
- **Stage 1 docs convergence (2026-02-10):** Updated active user docs (`README`, optimizer docs) to remove legacy snippets and align examples to typed metric API.
- **Stage 1 audit gates (2026-02-10):** Ran 3 adversarial subagent audits post-apply; resolved all reported P1 findings before closing validation gates.
- **State transition (2026-02-10):** Advanced workflow to `Slice 5 / Research` after 4.5-lite completion; V5 is now the active slice.
- **Slice 5 research arbitration (2026-02-10):** Accepted `slice_5_research.md` as implementation baseline. Locked V5 to struct-field walker recursion with explicit container errors (per N18 + S5 deferral), and carried forward the U50 API ambiguity (`metric` arg in breadboard vs then-current `Evaluator`-bound compile trait) into planning for explicit resolution. This ambiguity is now closed by Stage 1 cleanup (typed metric compile contract landed).
- **Execution heuristic (2026-02-10):** For ambiguous V5 details, follow spec spirit while choosing the shortest correct implementation path; avoid adding migration scaffolding unless required for green builds, and record every shortcut as explicit cleanup debt for post-slice reconciliation.
- **Slice 5 plan review (2026-02-10):** Accepted plan direction for F6/F8 core deliverables and quick-path migration strategy; at that time, plan refinery still needed to arbitrate strict U50/C4 fidelity (typed evaluator replacement vs temporary `Evaluator` carryover) and concrete Facet attribute payload syntax for `PredictAccessorFns`.
- **Slice 5 plan refinery arbitration (2026-02-10):** Resolved all `NEEDS ARBITRATION` markers in `slice_5.md`. Chosen path for that slice window: land F6/F8 (`DynPredictor` + walker + optimizer rewiring) with minimal churn by keeping the `Evaluator` metric boundary temporarily, while explicitly recording C4 typed-evaluator replacement as migration debt for post-V5/V6 cleanup. This temporary decision has since been superseded by Stage 1 cleanup.
- **Slice 5 implementation validation (2026-02-10):** `cargo check -p dspy-rs`, `cargo check -p dspy-rs --examples`, and `cargo test -p dspy-rs --lib --tests` all pass after V5 rewiring (`named_parameters`, `DynPredictor`, optimizer integrations, and new V5 regression tests).
- **Slice 5 mechanism audit (2026-02-10):** Queried Facet indexed resources via Nia to validate S2 Mechanism A (`define_attr_grammar!` + typed attr decode). Attempted direct `#[facet(dsrs::parameter = ...)]` payload path and hit compile blockers for generic function-pointer payload attachment (`E0401`) in current derive expansion. Kept registry-backed accessor mapping for this slice as the shortest correct path and recorded as migration debt for cleanup.
- **Slice 5 smoke test (2026-02-10):** Added and ran `crates/dspy-rs/examples/94-smoke-slice5-optimizer-interface.rs` against `openai:gpt-5.2` with `.env` loaded; walker discovered `named_parameters: [\"predictor\"]`, instruction mutation took effect, and call returned `answer: smoke-ok`.
- **Slice 5 adversarial arbitration (2026-02-10):** Agreed and fixed finding on pointer/Box container guard gap (`Def::Pointer` now errors as container when it encloses parameter leaves) and agreed on expanding V5 regression coverage (state dump/load roundtrip + deterministic multi-leaf ordering tests).
- **Slice 5 adversarial arbitration (2026-02-10):** Deferred both high findings at the time: (1) S2 Mechanism A attr-payload discovery remains blocked by generic derive constraints in current implementation and is tracked as migration debt; (2) U50 typed metric surface (`compile(..., metric)`) was temporarily deferred per prior C4 decision to avoid duplicate migration churn before cleanup. Item (2) is now resolved by Stage 1 cleanup.
- **Slice 5 adversarial arbitration (2026-02-10):** Deferred GEPA uniform-entrypoint finding and legacy surface cleanup as post-V5/V6 cleanup work; no stale `NEEDS ARBITRATION` markers remain in Slice 5 docs.
- **Slice 5 post-fix smoke rerun (2026-02-10):** Re-ran `94-smoke-slice5-optimizer-interface` against `openai:gpt-5.2` after arbitrate fixes; still passes with `answer: smoke-ok`.
- **Slice 5 commit (2026-02-10):** Change `ovrlqprm` / `89d83af6` — "slice5: implement optimizer interface with dyn predictor walker".
- **Slice 5 closure audit (2026-02-10):** Updated `docs/plans/modules/slices_closure_audit.md` with V5 requirement accounting, explicit implemented/deferred classification (`U50`, S2 mechanism, GEPA entrypoint), and validation evidence including Slice 5 GPT-5.2 smoke.
- **State transition (2026-02-10):** Advanced tracker from Slice 5 closure to `Slice 6 / Research` per closure-audit transition rule (`slice < 6`).
- **Slice 6 research arbitration (2026-02-10):** Accepted `slice_6_research.md` as planning baseline for V6 (`F9`/`F10`) with graph-first sequencing (`DynModule/registry` → `ProgramGraph` mutation/validation → execution → typed projection).
- **Slice 6 research discrepancy note (2026-02-10):** Confirmed a concrete tension between design example `ProgramGraph::from_module(&module)` and current discovery surface `named_parameters(&mut module)`. Planning must explicitly choose immutable projection API vs mutable-only projection path.
- **Slice 6 `from_module` mutability resolution (2026-02-09):** Resolved via **snapshot-then-fit-back** semantics. `ProgramGraph::from_module(&module)` takes `&module` (immutable), reads each predictor's schema + state via an immutable walker variant, and creates standalone `DynModule` wrappers (owned, decoupled from source module). The optimizer mutates the graph independently. After optimization, `graph.fit(&mut module)` applies optimized state back to the typed module's predictors via `load_state` on path-matched leaves. Implementation requires: (1) add `fn(*const ()) -> *const dyn DynPredictor` to `PredictAccessorFns` for immutable accessor; (2) add `named_parameters_ref(&module) -> Vec<(String, &dyn DynPredictor)>` immutable walker variant; (3) `from_module` calls immutable walker, reads `.schema()` + `.dump_state()`, constructs independent graph nodes; (4) `graph.fit(&mut module)` uses existing mutable walker to write back. Structural divergences (topology changes in the graph that don't map to typed module paths) are surfaced, not silently dropped. Rationale: keeps typed path zero-cost (no Arc/Mutex), matches spec signatures (breadboard U46 `&module`, design_reference §11 `&M`, shapes F6 `&dyn DynPredictor`), and the `&mut` lives where mutation actually happens (fit-back), not where it doesn't (projection).
- **Slice 6 research discrepancy note (2026-02-10):** Locked annotation-first edge derivation for `ProgramGraph::from_module` per prior C8 decision; trace-inferred wiring remains deferred until post-V6 cleanup unless required by a blocker.
- **Slice 6 planning execution note (2026-02-10):** Initial planning subagent (`019c457a-a6d4-7892-8e0a-cc58d11f80a1`) stalled with no deliverable after repeated waits/interrupt; replaced by `019c4582-c2dc-7f81-963c-2b2b2780005d` with tighter repo-grounding constraints.
- **Slice 6 ambiguity resolution sync (2026-02-10):** Incorporated user-authored clarifications from `slice_6_research.md` before finalizing plan, including snapshot-then-fit-back (`from_module(&module)` via immutable walker + `fit(&mut module)` write-back), explicit structural divergence surfacing, and annotation-first edge derivation.
- **Slice 6 plan initial review (2026-02-10):** Accepted `slice_6.md` as Plan-phase baseline and advanced to Plan Refinery. Refinery must explicitly verify two fidelity risks: (1) whether `from_module` should return `ProgramGraph` exactly (U46) versus `Result<ProgramGraph, GraphError>` in the plan draft; (2) whether proposed `SignatureSchema` cloning constructors preserve existing lifetime/ownership constraints without mutating global cached schemas.
- **Slice 6 plan refinery outcome (2026-02-10):** Accepted refinery corrections in `slice_6.md`/`slice_6_refinery.md` (typed `StrategyError` APIs, `format_output_baml` helper, `insert_between` test coverage, and ordering fix requiring adapter helpers before dynamic factory implementation).
- **Slice 6 arbitration resolution (2026-02-10):** Resolved both plan markers: (1) keep global accessor registry bridge in V6 (defer shape-local attr payload migration to cleanup); (2) use global edge-annotation registration keyed by shape ID as the sole V6 annotation source (defer shape-local annotation storage to cleanup). All `NEEDS ARBITRATION` markers for Slice 6 are cleared.
- **State transition (2026-02-10):** Advanced Slice 6 from `Plan Refinery` to `Implement` after arbitration closure.
- **Slice 6 implement completion pass (2026-02-10):** Added strict typed/dynamic prompt parity coverage for both `predict` and `chain_of_thought` (`test_program_graph_execution.rs`) and aligned dynamic CoT reasoning-field docs to typed schema prompt behavior.
- **Slice 6 validation sweep (2026-02-10):** `cargo test -p dspy-rs --lib --tests` and `cargo check -p dspy-rs --examples` both pass after V6 implementation updates; no failing regressions remain in crate-level tests.
- **Facet API verification (2026-02-10):** Re-ran Nia semantic queries over indexed `facet-rs/facet` + docs resources to confirm current walker/accessor model (`Peek`/`Poke` + pointer vtables + attr grammar mechanics). Kept registry bridge for V6 per prior arbitration and migration-debt policy.
- **State transition (2026-02-10):** Advanced Slice 6 from `Implement` to `Adversarial Review` and spawned review subagent `019c45a4-fb62-7e62-8efa-b2d050d15e2c`.
- **Slice 6 adversarial review outcome (2026-02-10):** `slice_6_review.md` reported 6 findings (2 high, 3 medium, 1 low). Agreed with all findings and applied fixes in-slice; no deferrals.
- **Slice 6 arbitrate fixes (2026-02-10):**
  - Implemented true dynamic ReAct orchestration (`action` + `extract` predictors, iterative loop, terminal action handling, tool-call/execution metadata accumulation) and strict `react` config validation (`InvalidConfig` on malformed `max_steps`).
  - Added breadboard input wiring semantics: `connect("input", ...)` is now supported; execution resolves pseudo-node edges from root input; topo-sort ignores pseudo-node dependency edges.
  - Reduced dynamic API friction: `ProgramGraph::add_node`/`replace_node` now accept `impl Into<Node>`, so `Box<dyn DynModule>` from `registry::create` can be passed directly while schema/module sync is enforced at insertion.
  - Added projection fallback and guardrails: `from_module` remains annotation-first but now falls back to ordered schema/path inference when annotations are absent, and errors on unresolved multi-node projections.
  - Made `insert_between` failure-atomic for missing inserted-node IO fields by pre-validating before graph mutation.
- **Slice 6 post-arbitrate validation (2026-02-10):** Re-ran targeted V6 suites plus full crate validation: `cargo test -p dspy-rs --test test_registry_dynamic_modules --test test_program_graph_execution --test test_program_graph_mutation --test test_program_graph_annotations --test test_program_graph_projection_fit --test test_named_parameters_ref`, then `cargo test -p dspy-rs --lib --tests`, and `cargo check -p dspy-rs --examples` all pass.
- **Slice 6 smoke test (2026-02-10):** Added and ran `crates/dspy-rs/examples/95-smoke-slice6-dynamic-graph.rs` against `openai:gpt-5.2` with `.env` loaded; dynamic graph path (`registry::create` + `add_node` + `connect(\"input\", ...)` + `execute`) returned `answer: smoke-ok`.
- **State transition (2026-02-10):** Completed Slice 6 Arbitrate and advanced to `Commit`.
- **Slice 6 commit (2026-02-10):** Change `nmvtxvrn` — "slice6: implement dynamic graph registry and execution".
- **State transition (2026-02-10):** Advanced Slice 6 from `Commit` to `Closure Audit`.
- **Slice 6 closure audit (2026-02-10):** Updated `docs/plans/modules/slices_closure_audit.md` with V6 requirement accounting (`U38`-`U46`, `N17`, `N24`-`N27`, `R8`) and refreshed deferred-ledger entries for V6 annotation storage and TypeIR assignability breadth.
- **State transition (2026-02-10):** Because current slice = 6, advanced from `Closure Audit` to `Post-Implementation Cleanup`.
- **Calling convention revision (2026-02-09):** Replaced `CallOutcome<O>` with `Result<Predicted<O>, PredictError>` for typed module calls. `Predicted<O>` implements `Deref<Target = O>` for direct field access and carries `CallMetadata` (like DSPy's `Prediction`). Rationale: `CallOutcome` required `.into_result()?` on stable Rust, violating P1 ergonomics. Nightly `try_trait_v2` has no stabilization timeline. `Predicted<O>` + `Result` gives DSPy-parity ergonomics on stable: `module.call(input).await?.answer`. Canonical user entrypoint is `Module::call`; module authors implement `forward` as the hook.
- **Interpretation note:** historical entries below may still reference `CallOutcome` because they log pre-revision milestones. Treat those references as superseded unless an entry explicitly says otherwise.
- **Phase 4.5-lite completion (2026-02-10):** Exit gates passed. `cargo check -p dspy-rs`, `cargo check -p dspy-rs --examples`, and `cargo test` are green after C1/C5/C6 execution.
- **C1 implementation closeout (2026-02-10):** `Module::Input`/`Output` bounds now require `BamlType + for<'a> Facet<'a> + Send + Sync`, and combinator output bounds were tightened to match.
- **Facet safety correction (2026-02-10):** Replaced unsound shape aliasing on legacy `Example`/`Prediction` with derive-based Facet metadata so layout/type metadata stays truthful while data-heavy fields remain skipped/opaque.
- **C5 implementation closeout (2026-02-10):** Signature derive now emits clean helper names (`{Name}Input`, `{Name}Output`, `{Name}All`) and constructor helpers so users do not initialize phantom fields in literals.
- **C6 implementation closeout (2026-02-10):** `ChainOfThought.predictor`, `ReAct.action`, and `ReAct.extract` are Facet-transparent, while non-parameter ReAct fields remain skipped. Added shape traversal coverage in `crates/dspy-rs/tests/test_module_facet_shapes.rs` (CoT, ReAct, Map nesting).
- **C6 implementation note (2026-02-10):** `Map`/`AndThen` keep explicit `unsafe Facet` impls with skipped `facet::Opaque<F>` closure fields because current derive behavior imposes `F: Facet` for these generic wrappers.
- **Roadmap revision (2026-02-09):** Descoped Phase 4.5 to "4.5-lite" (prerequisites only). C1 (Module bounds), C5 (macro naming), C6 (Facet annotations) are in scope. C3 (optimizer ABI) and C4 (evaluator adapter) reclassified as V5 feature work. C2 (legacy quarantine) replaced by post-V6 kill pass (straight deletion, no intermediate scaffolding). Rationale: building compatibility wrappers for a system about to be replaced is waste. Full C1-C8 arbitration outcomes recorded in `phase_4_5_cleanup_kickoff.md`.
- **C1 arbitration (2026-02-09):** Accept option A (hard tighten now). `Module` bounds go to `BamlType + Facet` without compatibility wrappers. Legacy `Module<Input=Example, Output=Prediction>` impls stay on old types until kill pass.
- **C2 arbitration (2026-02-09):** Skip quarantine entirely. Legacy surfaces frozen in place until kill pass after V5+V6.
- **C3 arbitration (2026-02-09):** Reclassified as V5 scope. Optimizer ABI migration is the V5 slice definition.
- **C4 arbitration (2026-02-09):** Reclassified as V5 scope. Typed evaluator surface replaces legacy `Evaluator` trait.
- **C5 arbitration (2026-02-09):** Accept option B (redesign). Fix macro naming (`QAOutput` not `__QAOutput`) and phantom construction ergonomics.
- **C6 arbitration (2026-02-09):** Accept option B (full matrix). Fix `#[facet(opaque)]` on predictor fields; add walker traversal shape tests.
- **C7 arbitration (2026-02-09):** Accept option A (defer to V5). Error-path contract tests land when the walker exists.
- **C8 arbitration (2026-02-09):** Accept option B (lock strategy). Annotation-first with optional trace inference. Recorded for V6 planning.
- **State normalization (2026-02-09):** Tracker advanced from stale `Slice 3 / Done` to `Slice 4 / Research` per closure-audit transition rule (slice < 4 advances to next slice research).
- **ReAct DSPy parity arbitration (2026-02-09):** Removed separate trajectory call API from `ReAct` to keep a single call surface aligned with `F4` and DSPy reference behavior (`call` returns prediction while trajectory is part of returned data). Trajectory is now emitted through existing call metadata (`tool_executions`) and printed in smoke/tests without introducing another call path. Superseded return wrapper: `CallOutcome` -> `Result<Predicted<...>, PredictError>` per the calling convention revision.
- **ReAct calculator smoke proof (2026-02-09):** Updated `93-smoke-slice4-react-operational` to exercise multi-tool calculator flow (`add` → `multiply` → `add` → `finish`) and print step-by-step trajectory from metadata; real-model smoke on `openai:gpt-5.2` passed with `tool_calls: 3`, `tool_executions: 5`, `answer: 70`.
- **Slice 4 research arbitration (2026-02-09):** Reclassified `U48` from `[EXISTS]` to `[MODIFY]` in `slice_4_research.md`; batching semantics are present, but API shape currently requires `display_progress` and does not match breadboard’s 3-arg `forward_all(&module, inputs, concurrency)`.
- **Slice 4 plan review (2026-02-09):** Accepted high-level sequencing (U48 surface alignment → U51 combinators → U14 ReAct + tests), but flagged two areas for refinery against code/spec: (1) exact Facet strategy for closure-bearing wrappers (`Map`/`AndThen`), and (2) concrete plain-function tool adapter surface for ReAct builder.
- **Slice 4 refinery arbitration (2026-02-09):** Resolved `and_then` metadata ambiguity by locking `ModuleExt::and_then` to a fallible transform signature `Fn(Output) -> Result<T, CallOutcomeErrorKind>` that preserves inner call metadata; removed stale `NEEDS ARBITRATION` marker from `slice_4.md`.
- **Slice 4 smoke test (2026-02-09):** Real LM call passed end-to-end via `cargo run -p dspy-rs --example 93-smoke-slice4-react-operational` (loaded `.env`, model `openai:gpt-5.2`), returning `answer: smoke-ok`.
- **Slice 4 arbitrate (2026-02-09):** Agreed with high finding on ReAct Facet discoverability and fixed in `modules/react.rs`. Re-ran compile/tests and smoke after fix; smoke now reports `tool_executions: 1`, `answer: smoke-ok`.
- **Slice 4 arbitrate (2026-02-09):** Disagreed with medium finding (“ReAct bypasses adapter building blocks”) for this slice: both action/extract calls execute through `Predict::call` → `ChatAdapter` pipeline (`N8/F7`). The hand-built `trajectory` string is module orchestration state, not a replacement parsing/formatting pipeline; no immediate correctness gap observed in tests/smoke.
- **Slice 4 implementation (2026-02-09):** Added `ReAct<S>` module (`modules/react.rs`) with plain async tool builder (`.tool(name, desc, fn)`), action/extract loop over typed `Predict` leaves, and Facet discoverability on the wrapper struct.
- **Slice 4 implementation (2026-02-09):** Added operational affordances: new 3-arg `forward_all(&module, inputs, concurrency)` surface, `forward_all_with_progress` compatibility helper, and `ModuleExt::{map,and_then}` wrappers in `core/module_ext.rs`.
- **Slice 4 validation (2026-02-09):** `cargo check -p dspy-rs`, `cargo check -p dspy-rs --examples`, and targeted tests (`test_module_forward_all`, `test_module_ext`, `test_react_builder`, `test_chain_of_thought_swap`) passed.
- **Slice 4 smoke test (post-fix, 2026-02-09):** `cargo run -p dspy-rs --example 93-smoke-slice4-react-operational` against `openai:gpt-5.2` passed (`tool_executions: 1`, `answer: smoke-ok`).
- **Slice 4 commit (2026-02-09):** Change `nluquynv` / `d768449f` — \"slice4: implement react and operational affordances\".
- **Slice 4 closure audit (2026-02-09):** Added `docs/plans/modules/slices_closure_audit.md` with `V4` requirement accounting and consolidated deferred ledger routing. Because slice = 4, workflow advanced to Post-Implementation Cleanup.
- **Post-Implementation Cleanup (2026-02-09):** Resolved `U29` by deriving `facet::Facet` on `ChainOfThought` (`crates/dspy-rs/src/modules/chain_of_thought.rs`) and revalidated targeted module tests/smokes.
- **Post-Implementation Cleanup (2026-02-09):** Resolved `build_system` API/spec mismatch by aligning spec docs to the implemented fallible surface (`Result<String>`) in `breadboard.md` and `design_reference.md`.
- **Post-Implementation Cleanup (2026-02-09):** Ran full workspace validation (`cargo test`) successfully after cleanup edits.
- Slice definitions for this execution are V1-V3 from `/Users/darin/src/personal/DSRs/docs/specs/modules/breadboard.md` (V1 Typed call, V2 Augmentation + CoT, V3 Module authoring).
- Ground truth hierarchy for arbitration is: breadboard + shapes + design_reference + spikes S1-S8.
- **Superseded lock (2026-02-09):** N8/typed call default return was `CallOutcome<O>` (metadata-first) with `call_with_meta` folded into `call`. Superseded the same day by the calling convention revision to `Result<Predicted<O>, PredictError>` with `Module::call` as canonical and `forward` as implementation hook.
- **Calling convention constraint (updated):** single return type + single convention. `Module::call` returns `Result<Predicted<O>, PredictError>` and delegates to `forward`; no parallel convenience call path.
- **Error payload constraint:** errors must carry call metadata context (raw response/usage/field parse detail) in the same default return flow.
- **Plan review decision (2026-02-09):** Slice 1 plan must align with S1/S6 Option C replacement direction; broad legacy compatibility strategy in draft plan requires refinery correction or explicit arbitration.
- **Arbitration (2026-02-09): Flatten alias/constraint semantics.** `SignatureSchema` enforces unique LM-visible names per side (input/output). Collisions after flatten are hard errors with path detail. Constraints/format metadata are attached to flattened emitted leaf paths.
- **Superseded arbitration (2026-02-09): `CallOutcome` ergonomics.** Prior plan considered `Try`/`FromResidual` on nightly (`try_trait_v2`) with `into_result()`. Superseded by `Result<Predicted<...>, PredictError>` on stable.
- **Implementation decision (2026-02-09):** Keep minimal optimizer file edits in `optimizer/gepa.rs` and `optimizer/mipro.rs` because they were mechanical call-site adaptations required by typed module invocation; no optimizer behavior changes were introduced.
- **Adversarial arbitration (2026-02-09):** Accepted high-severity review finding on legacy flatten marker mismatch. Fixed by (1) emitting `FieldSchema::lm_name` keys in `schema_fields_to_value`, and (2) updating `FIELD_HEADER_PATTERN` to parse non-`\w` marker names (including dotted aliases/paths).
- **Smoke test (2026-02-09):** Real LM call passed end-to-end using `cargo run -p dspy-rs --example _slice1_smoke` with `.env` `OPENAI_API_KEY` and model `openai:gpt-5.2`; typed path returned expected `answer = "smoke-ok"`.
- **Arbitration result (2026-02-09):** Agreed with the single review finding and fixed it in-place (`predict.rs` legacy field-key mapping and `chat.rs` header regex). Post-fix test suite and smoke run passed.
- **Slice 1 commit (2026-02-09):** `rkuwmrtq` / `229404b5` — "slice1: implement typed call with SignatureSchema and CallOutcome".
- **Slice 2 plan review (2026-02-09):** Draft plan needs refinery arbitration on augmentation trait signatures, wrapper mutability contract (`Deref` vs `DerefMut`), and ChainOfThought public constructor ergonomics to match breadboard U13 and S3/S7 decisions.
- **Slice 2 arbitration (2026-02-09):** Resolved `ChainOfThought` API to provide `new()` (U13) plus delegated full builder DSL (`demos`/`instruction`/`tools`) via `ChainOfThoughtBuilder`, and locked augmentation wrappers to `Deref`-only (no `DerefMut`) per S3.
- **Slice 2 implementation (2026-02-09):** `WithReasoning<O>` now derives `facet::Facet` directly and implements `BamlSchema` manually (instead of `#[BamlType]`) to avoid HRTB conflicts in the macro expansion while preserving `BamlType` via blanket impl.
- **Slice 2 implementation (2026-02-09):** Adapter formatting uses relaxed path lookup to handle `#[facet(flatten)]` outputs whose BamlValue serialization flattens fields while parsing still expects nested paths.
- **Slice 2 smoke test (2026-02-09):** Real LM calls passed end-to-end against `openai:gpt-5.2` via named examples: `cargo run -p dspy-rs --example 90-smoke-slice1-typed-predict` (`answer = smoke-ok`) and `cargo run -p dspy-rs --example 91-smoke-slice2-chain-of-thought` (`answer = smoke-ok`, reasoning populated).
- **Slice 2 arbitrate (2026-02-09):** Accepted finding on legacy optimizer visibility and fixed by exposing `predictor` through `ChainOfThought::parameters()`. Re-ran Slice 2 smoke test after fix; still passes (`answer = smoke-ok`).
- **Slice 2 arbitrate (2026-02-09):** Deferred review findings on `Facet` derivation and typed module-call contract as cross-slice architectural alignment work; current Slice 2 deliverable remains consistent with the existing `Module` trait contract introduced in Slice 1.
- **Slice 2 commit (2026-02-09):** `owmrznzo` / `748368c8` — "slice2: implement augmentation + chain-of-thought module".
- **Slice 3 research (2026-02-09):** Accepted recommendation that V3 requires completing F4/F12 (typed `Module` surface + generic/flatten signature authoring) and exposing schema-driven adapter building blocks; this is a high-blast-radius migration that must preserve `CallOutcome` metadata semantics.
- **Slice 3 plan review (2026-02-09):** Accepted high-level sequencing (schema/derive → trait migration → adapter surface → module updates → tests), but flagged concrete type/API drift in the draft plan (non-existent symbols like `ChatMessage`/`schema_from_signature`, incorrect import ownership for `BamlType`). Refine against ground truth before implementation.
- **Slice 3 refinery arbitration (2026-02-09):** Refined plan passed fidelity/shape/breadboard/sequencing/API/over-engineering checks and explicit test-comprehensiveness review, but implementation will use in-repo symbols as source of truth where plan text still references speculative names.
- **Process note (2026-02-09):** Planning subagent prompts must explicitly require grounding in the repository (current code paths/patterns), in addition to the research doc and tracker decisions, to avoid speculative API names.
- **Slice 3 implementation (2026-02-09):** Completed typed module-authoring migration across core and examples: `Module` now uses associated `Input`/`Output`, `forward_all` free helper is used for batching, generic signature derive supports flatten with generated helper structs + Facet/BamlSchema plumbing, and schema-first adapter helpers are exposed for system/input/output formatting and parse paths.
- **Slice 3 implementation (2026-02-09):** Migrated examples to the new authoring syntax (`CallOutcome` handling, removed `call_with_meta`, replaced member `.batch(...)` with `forward_all(...)`) and added labeled smoke example `crates/dspy-rs/examples/92-smoke-slice3-module-authoring.rs`.
- **Slice 3 validation (2026-02-09):** `cargo check -p dspy-rs -p dsrs_macros`, `cargo test -p dsrs_macros --tests`, `cargo test -p dspy-rs --lib --tests`, and `cargo check -p dspy-rs --examples` all pass.
- **Slice 3 smoke test (2026-02-09):** Loaded `.env` and ran labeled real-model smokes against `openai:gpt-5.2`: `90-smoke-slice1-typed-predict`, `91-smoke-slice2-chain-of-thought`, and `92-smoke-slice3-module-authoring`; all returned `answer: smoke-ok`.
- **Slice 3 arbitration (2026-02-09):** Review finding on `__phantom` public leakage is stale after current implementation (`__phantom` is private). Other findings (Option-C full legacy removal, strict typed bounds on `Module`, and `build_system` fallibility) are recorded as intentional scope/compatibility tradeoffs for Slice 3 and deferred for explicit future architectural decision.
- **Slice 3 commit (2026-02-09):** Change `strkwqpy` — "slice3: implement module authoring syntax and schema helpers".
- **Process decision (2026-02-09):** Add explicit phase `Closure Audit` after `Commit` and before `Done` for slices that complete implementation. The phase output is a requirements ledger that marks each in-scope item as Implemented / Partially Implemented / Deferred with evidence and a named follow-up phase.
- **Closure audit result (2026-02-09):** `docs/plans/modules/slices_1_3_closure_audit.md` is the source of truth for slices 1–3 accounting. Summary: V1 implemented; V2 partially implemented (U29 deferred); V3 partially implemented (typed-bound/generic-hardening + legacy-cutover deferrals).
- **Deferral mapping (2026-02-09):** Assigned explicit follow-up phases: `Phase 4.5 Cleanup / API Surface Pass` (typed module bounds + generic helper contract + phantom ergonomics + `build_system` API/spec reconciliation + legacy cutover prep/removal) and `V5 Implement` (Facet walker discoverability for module wrappers).
- **Planning update (2026-02-09):** Consolidated deferred cleanup items into an explicit **Phase 4.5: Cleanup / API Surface Pass**. This phase is now the canonical destination for strict typed module bounds, macro helper generic/ergonomic cleanup, adapter surface reconciliation, and legacy API cutover prep/removal.

## Stumbling Blocks
<!-- Things that were confusing, ambiguous, or required judgment calls -->
- Existing tracker lacked `Current State` fields from the required template; normalized before continuing to avoid ambiguous phase transitions.
- Initial research draft mixed Slice 1 scope with Slice 2/5 artifacts (augmentation and DynPredictor migration). Corrected to keep Slice 1 deliverables focused on V1 call path while preserving cross-slice constraints.
- Implementation subagent introduced unexpected edits outside assigned ownership (`optimizer/gepa.rs`, `optimizer/mipro.rs`) while attempting to satisfy compile ripple effects from `Module` return type changes.
- `cargo check -p dspy-rs --examples` initially failed after the module trait migration due stale example syntax (`call_with_meta`, untyped `Module` impls, member `.batch(...)`). Resolved by updating all impacted examples and adding a Slice 3 smoke example.
- Slice 2 planning subagent produced no deliverable (`slice_2.md` missing) and had to be replaced.
- Slice 2 adversarial review subagent took longer than expected; waited through multiple polls before completion.
- Slice 3 research confirms V3 is not incremental polish: it requires trait-shape migration across core module/predictor surfaces and may ripple into optimizer and examples.
- S2 Mechanism A direct attr-payload implementation in generic `Predict<S>` currently fails due derive-generated static context rejecting outer generic parameter use for accessor fn payload (`E0401`), so V5 uses a runtime accessor registry fallback.

## Open Questions
<!-- Unresolved issues to revisit -->
- `Post-Implementation Cleanup` remaining scope: generic-helper/`__phantom` ergonomics plus remaining S2 mechanism debt (predict-accessor fallback) and TypeIR assignability breadth remain non-trivial migrations with broad compatibility impact.
- Typed metric/evaluator migration boundary is now closed in code (`Optimizer::compile(..., metric)` + `TypedMetric` + GEPA feedback gate); remaining open question is only how aggressively to prune or annotate historical planning notes so they cannot be misread as active API guidance.
- Decision matrix and sequencing for cleanup kickoff are now centralized in `docs/plans/modules/phase_4_5_cleanup_kickoff.md`.
- ~~`V6`: resolve `ProgramGraph::from_module` mutability contract~~ → **Resolved.** See decision entry below.
- `V6`: define v1 graph output contract for multi-sink graphs (single terminal node requirement vs aggregate-output shape).

## Migration Debt
<!-- Compatibility shims and legacy bridges left in place during slices. Each gets removed in Post-Implementation Cleanup. -->
- **V5-S2 accessor fallback:** `crates/dspy-rs/src/core/dyn_predictor.rs` uses runtime `register_predict_accessor(shape.id -> fn)` plus `shape.type_identifier == "Predict"` detection instead of shape-local `dsrs::parameter` payload extraction. Exit criteria: implement attr-driven accessor payload (Mechanism A) or equivalent audited replacement without runtime registry.
- **V6-TypeIR assignability breadth:** `TypeIR::is_assignable_to` remains intentionally conservative (exact match, nullable widening, simple unions, and structural list/map/tuple checks). Exit criteria: fuller subtyping semantics for richer unions/aliases/classes without destabilizing edge validation.
- **Resolved in Stage 2 (2026-02-10):** S8 global edge-annotation registry debt is closed; active projection surface is explicit per-call annotations (`from_module_with_annotations`) with no ambient global annotation state.
- **Resolved in Stage 1 (2026-02-10):** V5-C4 evaluator bridge removed (typed metric entrypoint landed) and legacy optimizer surfaces deleted.
